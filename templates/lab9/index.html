{% extends 'base.html' %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block script %}{% endblock %}

{% block main %}
<div style="background: linear-gradient(135deg, #1a472a 0%, #0c2d1a 100%); padding: 20px; border-radius: 15px; border: 3px solid #c41e3a;">
    <h2 style="color: #ffd700; text-align: center; font-family: 'Georgia', serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏ üéÅ</h2>

    <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 20px 0; border: 2px dashed #ffd700;">
        <p style="color: white; font-size: 18px; margin: 0;">
            –ù–µ–æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫: 
            <span id="count" style="color: #ffd700; font-weight: bold; font-size: 24px;">{{ unopened_count }}</span>
        </p>
    </div>

    <div class="user-status" style="background: #c41e3a; color: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #ffd700;">
        {% if current_user.is_authenticated %}
            üéÖ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong style="color: #ffd700;">{{ current_user.login }}</strong>
        {% else %}
            ‚ùÑÔ∏è –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã
        {% endif %}
    </div>

    <div style="display: flex; gap: 15px; margin-bottom: 25px;">
        {% if not current_user.is_authenticated %}
            <a class="menu-link" href="/lab8/login" style="
                background: #c41e3a;
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                text-decoration: none;
                border: 2px solid #ffd700;
                font-weight: bold;
            ">–í—Ö–æ–¥ –≤ –º–∞—Å—Ç–µ—Ä—Å–∫—É—é</a>
        {% endif %}
        {% if current_user.is_authenticated %}
            <a class="menu-link" href="/lab8/logout" style="
                background: #2d5a27;
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                text-decoration: none;
                border: 2px solid #ffd700;
                font-weight: bold;
            ">–í—ã—Ö–æ–¥</a>
        {% endif %}
    </div>

    {% if current_user.is_authenticated %}
    <div style="text-align: center; margin-bottom: 30px;">
        <button onclick="resetBoxes()" style="
            background: linear-gradient(to bottom, #c41e3a, #8b0000);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            border: 3px solid #ffd700;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        ">
            üéÑ –î–µ–¥ –ú–æ—Ä–æ–∑, –æ–±–Ω–æ–≤–∏ –ø–æ–¥–∞—Ä–∫–∏! üéÑ
        </button>
    </div>
    {% endif %}

    <div style="
        position: relative; 
        height: 500px; 
        background: rgba(26, 71, 42, 0.3); 
        border-radius: 15px; 
        border: 3px solid #c41e3a;
        overflow: hidden;
    ">
        {% for id, box in boxes.items() %}
            <img
                src="/static/{{ box.box }}"
                id="box{{ id }}"
                onclick="openBox({{ id }})"
                style="
                    position: absolute;
                    top: {{ positions[id]['top'] }}px;
                    left: {{ positions[id]['left'] }}px;
                    width: 200px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.5));
                    {% if box.opened %}opacity: 0.3; transform: scale(0.95);{% endif %}
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='{% if box.opened %}scale(0.95){% else %}scale(1){% endif %}'"
            >
        {% endfor %}
        
        <div style="position: absolute; top: 10px; right: 10px; font-size: 30px;">üéÑ</div>
        <div style="position: absolute; bottom: 10px; left: 10px; font-size: 30px;">‚ú®</div>
        <div style="position: absolute; top: 50%; left: 10px; font-size: 30px;">‚ùÑÔ∏è</div>
    </div>

    <div id="result"></div>
    
    <div id="modal" style="
        display:none;
        position:fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:rgba(10, 40, 20, 0.95);
        z-index: 1000;
    ">
        <div style="
            background: linear-gradient(135deg, #1a472a 0%, #0c2d1a 100%);
            width:500px;
            margin:60px auto;
            padding:30px;
            text-align:center;
            position:relative;
            border-radius: 15px;
            border: 4px solid #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        ">
            <span onclick="closeModal()" style="
                position:absolute;
                top:10px; right:15px;
                cursor:pointer;
                color: #ffd700;
                font-size: 24px;
                font-weight: bold;
            ">‚úñ</span>

            <div id="modal-content" style="color: white; font-family: 'Georgia', serif;"></div>
        </div>
    </div>
</div>

<script>
function openBox(id) {
    fetch('/lab9/open', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({box_id: id})
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) { 
            alert(data.error); 
            return; 
        }

        const boxElement = document.getElementById('box' + id);
        boxElement.style.opacity = '0.3';
        boxElement.style.transform = 'scale(0.95)';

        document.getElementById('modal-content').innerHTML =
            `<h3 style="color: #ffd700; margin-bottom: 20px;">üéÅ –í–æ—Ç –≤–∞—à –ø–æ–¥–∞—Ä–æ–∫! üéÅ</h3>
            <p style="font-size: 18px; margin-bottom: 25px;">${data.text}</p>
            <img src="/static/${data.gift}" width="250" style="
                border: 3px solid #ffd700;
                border-radius: 10px;
                padding: 10px;
                background: rgba(255, 255, 255, 0.1);
            ">
            <p style="margin-top: 25px; color: #ffd700; font-size: 16px;">
                –û—Å—Ç–∞–ª–æ—Å—å –Ω–µ–æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤: ${data.opened_left}
            </p>`;

        document.getElementById('modal').style.display = 'block';
        document.getElementById('count').innerText = data.opened_left;
    });
}

function closeModal() {
    document.getElementById('modal').style.display = 'none';
}

function resetBoxes() {
    if(confirm('üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ —Å–ø—Ä—è—á–µ—Ç –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏ –∏ –ø–æ–ª–æ–∂–∏—Ç –Ω–æ–≤—ã–µ! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
        fetch('/lab9/reset', {method: 'POST'})
            .then(() => location.reload());
    }
}
</script>
{% endblock %}